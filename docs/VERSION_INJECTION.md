# Automatic Version Injection

This document explains how the firmware version is automatically injected from git tags during the build process.

## Overview

The firmware displays the version number at boot time for 1 second on the LED matrix display. The version is automatically extracted from git tags during the build process.

## How It Works

### Local Development

When building locally with `pio run`, the firmware will display:
- **"vdev"** - Default development version (from `src/version.h`)

### GitHub Actions Build

When GitHub Actions builds the firmware (on tag push), it will display:
- **"v1.4.0"** - The actual git tag version (e.g., if you push tag `v1.4.0`)
- **"abc1234"** - Git commit hash if no tags exist

## Implementation Details

### 1. Version Header File (`src/version.h`)

This file contains the default version for local development:

```c
// Auto-generated file - DO NOT EDIT
// This is a default version for local development
// GitHub Actions will overwrite this with the actual git tag

#pragma once

#ifndef FIRMWARE_VERSION
#define FIRMWARE_VERSION "dev"
#endif
```

**Note**: This file is committed to git so local builds always work.

### 2. GitHub Actions Workflow (`.github/workflows/main.yml`)

The workflow includes a step that generates the version header before building:

```yaml
- name: Generate version header
  run: |
    # Get version from git tag or commit
    if git describe --tags --abbrev=0 2>/dev/null; then
      VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
    else
      VERSION=$(git describe --always --dirty)
    fi
    echo "Firmware version: $VERSION"
    
    # Generate version.h
    cat > src/version.h << EOF
    // Auto-generated file - DO NOT EDIT
    // Generated by GitHub Actions
    
    #pragma once
    
    #define FIRMWARE_VERSION "$VERSION"
    EOF
    
    cat src/version.h
```

This step:
1. Tries to get the latest git tag using `git describe --tags --abbrev=0`
2. Removes the "v" prefix if present (e.g., "v1.4.0" becomes "1.4.0")
3. Falls back to commit hash if no tags exist
4. Overwrites `src/version.h` with the actual version
5. Continues with the normal build process

### 3. Firmware Code (`src/gfx.c`)

The firmware displays the version at boot:

```c
#include "version.h"

// In gfx_initialize():
display_clear();
char version_text[32];
snprintf(version_text, sizeof(version_text), "v%s", FIRMWARE_VERSION);

// Calculate x position to center text
int text_width = strlen(version_text) * 6;
int x = (64 - text_width) / 2;

display_text(version_text, x, 12, 255, 255, 255, 1);  // White text, centered
vTaskDelay(pdMS_TO_TICKS(1000));  // Display for 1 second
```

## Creating a Release

To create a new release with automatic version injection:

1. **Commit your changes:**
   ```bash
   git add .
   git commit -m "Your commit message"
   ```

2. **Create and push a tag:**
   ```bash
   git tag v1.5.0
   git push origin v1.5.0
   ```

3. **GitHub Actions will automatically:**
   - Extract the version "1.5.0" from the tag
   - Generate `src/version.h` with `#define FIRMWARE_VERSION "1.5.0"`
   - Build the firmware
   - Create a GitHub release with the firmware binaries
   - The firmware will display "v1.5.0" at boot

## Version Display

The version is displayed:
- **Location**: Centered on the LED matrix display
- **Duration**: 1 second
- **Color**: White (RGB 255, 255, 255)
- **Font**: 5x7 bitmap font
- **Position**: Vertically centered at y=12 (on 64x32 display)

## Troubleshooting

### Version shows "vdev" in production
- Make sure you're using the firmware built by GitHub Actions, not a local build
- Verify the git tag was pushed: `git tag -l`

### Version shows commit hash instead of tag
- No git tags exist in the repository
- Create a tag: `git tag v1.0.0 && git push origin v1.0.0`

### Version not displaying at boot
- Check serial monitor for boot messages
- Verify `gfx_initialize()` is being called
- Check that display is working properly

## Files Involved

- **`src/version.h`** - Version header file (default: "dev")
- **`src/gfx.c`** - Displays version at boot
- **`.github/workflows/main.yml`** - GitHub Actions workflow that injects version
- **`src/font5x7.h`** - Bitmap font used for text display
- **`src/display.cpp`** - Text rendering implementation

## Future Enhancements

Possible improvements:
- Display version in WiFi AP mode configuration page
- Add version to websocket handshake
- Include build date/time in version display
- Add OTA update capability with version checking

